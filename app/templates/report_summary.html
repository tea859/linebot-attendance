{% extends "base.html" %}

{% block title %}授業別レポート{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-end mb-6">
        <div>
            <h2 class="text-2xl font-bold text-slate-700 flex items-center gap-2">
                <i class="fas fa-chart-bar text-emerald-500"></i> 授業別出席レポート
            </h2>
            <p class="text-sm text-slate-500 mt-1">科目ごとの学生の出席状況を一覧表示します。</p>
        </div>
        
        <form method="GET" action="{{ url_for('web.report_summary') }}" class="flex gap-2">
            <select name="subject_key" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5 min-w-[200px]">
                <option value="" disabled {{ 'selected' if not selected_subject_key }}>-- 科目を選択 --</option>
                {% for row in all_subjects %}
                    <option value="{{ row.学期 }}-{{ row.授業ID }}" {{ 'selected' if selected_subject_key == (row.学期 ~ '-' ~ row.授業ID) }}>
                        第{{ row.学期 }}期 | {{ row.授業科目名 }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="text-white bg-emerald-600 hover:bg-emerald-700 font-bold rounded-lg text-sm px-5 py-2.5 shadow transition">
                表示
            </button>
        </form>
    </div>

    {% if report_data %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <span class="font-bold text-slate-600">現在までの総授業数: {{ report_data[0].total_classes_so_far }}回</span>
                <a href="{{ url_for('web.export_report_summary', subject_key=selected_subject_key) }}" class="text-emerald-600 hover:text-emerald-700 text-sm font-bold flex items-center gap-1">
                    <i class="fas fa-file-csv"></i> CSVダウンロード
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3 font-bold">ID</th>
                            <th class="px-6 py-3 font-bold">氏名</th>
                            <th class="px-6 py-3 font-bold">出席率</th>
                            <th class="px-6 py-3 font-bold text-center">出席</th>
                            <th class="px-6 py-3 font-bold text-center">遅刻</th>
                            <th class="px-6 py-3 font-bold text-center text-rose-500">欠席</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for row in report_data %}
                        <tr class="hover:bg-slate-50 transition">
                            <td class="px-6 py-4 font-mono text-slate-500">{{ row.id }}</td>
                            <td class="px-6 py-4 font-bold text-slate-700">{{ row.name }}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold {{ 'text-emerald-600' if row.attendance_rate >= 80 else 'text-rose-600' }}">{{ row.attendance_rate }}%</span>
                                    <div class="w-20 h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div class="h-full {{ 'bg-emerald-500' if row.attendance_rate >= 80 else 'bg-rose-500' }}" style="width: {{ row.attendance_rate }}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-emerald-600">{{ row.counts['出席'] }}</td>
                            <td class="px-6 py-4 text-center font-bold text-amber-600">{{ row.counts['遅刻'] }}</td>
                            <td class="px-6 py-4 text-center font-bold text-rose-600">{{ row.counts['欠席'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        {% if selected_subject_key %}
            <div class="text-center py-20 text-slate-400 font-bold">データがありません。</div>
        {% else %}
            <div class="text-center py-20 text-slate-400">
                <i class="fas fa-hand-point-up text-4xl mb-4 text-slate-300"></i>
                <p>上のメニューから科目を選択して表示ボタンを押してください。</p>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
