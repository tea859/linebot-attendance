{% extends "base.html" %}

{% block title %}詳細レポート{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    {% if is_portal_view %}
        <a href="{{ url_for('web.my_portal') }}#report" class="flex items-center gap-2 mb-6 cursor-pointer text-slate-500 hover:text-indigo-600 w-fit">
            <i class="fas fa-arrow-left"></i> <span class="font-bold">ポータルに戻る</span>
        </a>
    {% else %}
        <a href="{{ url_for('web.my_attendance', student_id=student_id) }}" class="flex items-center gap-2 mb-6 cursor-pointer text-slate-500 hover:text-indigo-600 w-fit">
            <i class="fas fa-arrow-left"></i> <span class="font-bold">一覧に戻る</span>
        </a>
    {% endif %}

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b pb-6 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                    <span class="bg-indigo-50 text-indigo-600 p-2 rounded-lg text-xl"><i class="fas fa-book"></i></span>
                    {{ subject_filter }}
                </h2>
                <div class="text-slate-500 mt-2 font-bold ml-1">
                    <i class="fas fa-user-graduate mr-1"></i> {{ student_name }}
                    <span class="mx-2 text-slate-300">|</span>
                    第{{ selected_kiki }}期
                </div>
            </div>
            
            <div class="flex gap-4 text-center">
                <div class="bg-slate-50 p-3 rounded-lg">
                    <div class="text-xs text-slate-400 font-bold mb-1">実施回数</div>
                    <div class="font-bold text-xl text-slate-700">{{ max_count }}</div>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            {% for row in report_data %}
                {% for i in range(1, max_count + 1) %}
                    {% set status = row['count_' ~ i ~ '_status'] %}
                    {% set display = row['count_' ~ i ~ '_display'] %}
                    {% set original = row['count_' ~ i ~ '_original_status'] %}
                    {% set is_phantom = row['count_' ~ i ~ '_is_phantom'] %}
                    {% set jigen = row['count_' ~ i ~ '_jigen'] %}

                    <div class="flex items-center justify-between p-4 rounded-xl border transition
                        {{ 'bg-emerald-50 border-emerald-100' if status == '○' else ('bg-amber-50 border-amber-100' if status == '△' else 'bg-rose-50 border-rose-100') }}">
                        
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white shadow-sm
                                {{ 'bg-emerald-400' if status == '○' else ('bg-amber-400' if status == '△' else 'bg-rose-400') }}">
                                {{ status }}
                            </div>
                            <div>
                                <div class="font-bold text-slate-700">
                                    {{ display.split('(')[1].replace(')', '') if '(' in display else '日付不明' }}
                                    <span class="text-sm font-normal text-slate-500 ml-2">{{ jigen }}限</span>
                                </div>
                                <div class="text-xs font-bold opacity-70
                                    {{ 'text-emerald-700' if status == '○' else ('text-amber-700' if status == '△' else 'text-rose-700') }}">
                                    {{ original }}
                                    {% if is_phantom %}(未記録){% endif %}
                                </div>
                            </div>
                        </div>

                        {% if is_phantom %}
                            <div class="text-xs bg-rose-200 text-rose-700 px-2 py-1 rounded font-bold">欠席扱い</div>
                        {% else %}
                            <div class="text-xs bg-white/50 text-slate-500 px-2 py-1 rounded font-bold">記録済</div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% endfor %}
        </div>

        {% if max_count == 0 %}
            <div class="text-center py-10 text-slate-400">まだ授業記録がありません。</div>
        {% endif %}
    </div>
</div>
{% endblock %}
