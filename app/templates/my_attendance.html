{% extends "base.html" %}

{% block title %}個人出席サマリー{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    {% if 'student-' in current_user.get_id() %}
        <a href="{{ url_for('web.my_portal') }}" class="flex items-center gap-2 mb-6 cursor-pointer text-slate-500 hover:text-indigo-600 w-fit">
            <i class="fas fa-home"></i> <span class="font-bold">ポータルへ戻る</span>
        </a>
    {% else %}
        <a href="{{ url_for('web.report_summary') }}" class="flex items-center gap-2 mb-6 cursor-pointer text-slate-500 hover:text-indigo-600 w-fit">
            <i class="fas fa-arrow-left"></i> <span class="font-bold">レポート一覧へ戻る</span>
        </a>
    {% endif %}

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h2 class="text-2xl font-bold text-slate-700 flex items-center gap-2">
                <i class="fas fa-id-card text-indigo-500"></i> {{ student_name }} さんの出席状況
            </h2>
            <p class="text-xs text-slate-400 mt-1 font-mono">Student ID: {{ student_id }}</p>
        </div>

        <div class="flex bg-white rounded-lg shadow-sm border p-1">
            {% for k in kikis %}
            <a href="{{ url_for('web.my_attendance', student_id=student_id, kiki=k) }}" 
               class="px-4 py-1 rounded text-sm font-bold transition {{ 'bg-indigo-600 text-white shadow' if k == selected_kiki else 'text-slate-500 hover:bg-slate-50' }}">
                第{{ k }}期
            </a>
            {% endfor %}
        </div>
    </div>

    {% if report_data %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for row in report_data %}
            
            {% set color = "rose" %}
            {% if row.attendance_rate >= 80 %}{% set color = "emerald" %}
            {% elif row.attendance_rate >= 50 %}{% set color = "amber" %}
            {% endif %}

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition group">
                <div class="p-5 border-b border-slate-50 relative">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-{{ color }}-100 to-transparent rounded-bl-full opacity-50"></div>
                    <h3 class="font-bold text-lg text-slate-700 relative z-10">{{ row.subject }}</h3>
                    <div class="flex items-end gap-2 mt-2">
                        <span class="text-4xl font-black text-{{ color }}-500 leading-none">{{ row.attendance_rate }}</span>
                        <span class="text-sm font-bold text-{{ color }}-600 mb-1">%</span>
                    </div>
                </div>
                
                <div class="p-5">
                    <div class="grid grid-cols-4 gap-2 text-center text-xs mb-4">
                        <div class="bg-slate-50 rounded p-1">
                            <div class="text-slate-400 mb-1">予定</div>
                            <div class="font-bold text-slate-700">{{ row.total_classes }}</div>
                        </div>
                        <div class="bg-emerald-50 rounded p-1">
                            <div class="text-emerald-600 mb-1">出席</div>
                            <div class="font-bold text-emerald-700">{{ row.attendance_count }}</div>
                        </div>
                        <div class="bg-amber-50 rounded p-1">
                            <div class="text-amber-600 mb-1">遅刻</div>
                            <div class="font-bold text-amber-700">{{ row.tardy_count }}</div>
                        </div>
                        <div class="bg-rose-50 rounded p-1">
                            <div class="text-rose-600 mb-1">欠席</div>
                            <div class="font-bold text-rose-700">{{ row.absent_count }}</div>
                        </div>
                    </div>

                    <a href="{{ url_for('web.my_attendance_detail', student_id=student_id, kiki=selected_kiki, subject=row.subject) }}" 
                       class="block w-full text-center bg-slate-50 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 font-bold py-2 rounded-lg transition text-sm">
                        詳細を見る <i class="fas fa-chevron-right ml-1"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300">
            <i class="far fa-folder-open text-4xl text-slate-300 mb-4"></i>
            <p class="text-slate-500 font-bold">履修データが見つかりません</p>
        </div>
    {% endif %}
</div>
{% endblock %}
