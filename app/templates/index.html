{% extends "base.html" %}

{% block title %}管理者ダッシュボード{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-2 space-y-8">
        
        <div>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <i class="far fa-clock"></i> 日常業務 & スケジュール
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <a href="{{ url_for('web.attendance', kiki=1) }}" class="bg-white border hover:border-blue-500 hover:shadow-md transition p-6 rounded-2xl flex flex-col items-center text-center group">
                    <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <span class="font-bold text-slate-700">出席登録</span>
                </a>

                <a href="{{ url_for('web.schedule') }}" class="bg-white border hover:border-indigo-500 hover:shadow-md transition p-6 rounded-2xl flex flex-col items-center text-center group">
                    <div class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <span class="font-bold text-slate-700">週時間割</span>
                </a>

                <a href="{{ url_for('web.schedule_monthly') }}" class="bg-white border hover:border-cyan-500 hover:shadow-md transition p-6 rounded-2xl flex flex-col items-center text-center group">
                    <div class="w-12 h-12 rounded-xl bg-cyan-50 text-cyan-600 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                        <i class="far fa-calendar-alt"></i>
                    </div>
                    <span class="font-bold text-slate-700">月間時間割</span>
                </a>
            </div>
        </div>

        <div>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie"></i> レポート & 通知
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <a href="{{ url_for('web.report_summary') }}" class="bg-white border hover:border-emerald-500 hover:shadow-md transition p-6 rounded-2xl flex items-center gap-4 group">
                    <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex-shrink-0 flex items-center justify-center text-xl">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">授業別レポート</div>
                        <div class="text-xs text-slate-400">出席率・CSV出力</div>
                    </div>
                </a>

                <a href="{{ url_for('web.alerts') }}" class="bg-white border hover:border-rose-500 hover:shadow-md transition p-6 rounded-2xl flex items-center gap-4 group relative">
                    {% if unresolved_alerts_count > 0 %}
                    <span class="absolute top-3 right-3 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
                    </span>
                    {% endif %}
                    <div class="w-12 h-12 rounded-xl bg-rose-50 text-rose-600 flex-shrink-0 flex items-center justify-center text-xl">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">連絡掲示板</div>
                        <div class="text-xs text-slate-400">遅刻・欠席届出: <b class="text-rose-500">{{ unresolved_alerts_count }}件</b></div>
                    </div>
                </a>
            </div>
        </div>
        
        <div>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <i class="fas fa-cogs"></i> システム管理
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <a href="{{ url_for('web.manage_students') }}" class="bg-white border hover:border-slate-400 hover:shadow-md transition p-6 rounded-2xl flex items-center gap-4 group">
                    <div class="w-12 h-12 rounded-xl bg-slate-100 text-slate-600 flex-shrink-0 flex items-center justify-center text-xl group-hover:bg-slate-600 group-hover:text-white transition">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">学生管理</div>
                    </div>
                </a>

                <a href="{{ url_for('web.manage_subjects') }}" class="bg-white border hover:border-slate-400 hover:shadow-md transition p-6 rounded-2xl flex items-center gap-4 group">
                    <div class="w-12 h-12 rounded-xl bg-slate-100 text-slate-600 flex-shrink-0 flex items-center justify-center text-xl group-hover:bg-slate-600 group-hover:text-white transition">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">授業管理</div>
                    </div>
                </a>
            </div>
        </div>

    </div>

    <div class="lg:col-span-1 space-y-6">
        <div class="bg-slate-800 rounded-2xl p-6 text-white shadow-xl">
            <div class="flex justify-between items-start mb-4">
                <h3 class="font-bold text-xs uppercase tracking-wider opacity-70">Room Condition</h3>
                <span class="bg-emerald-500/20 text-emerald-400 text-[10px] px-2 py-0.5 rounded border border-emerald-500/30 animate-pulse">LIVE</span>
            </div>
            <div class="flex justify-between items-end mb-6">
                <div>
                    <div class="text-3xl font-bold" id="temp-val">--.-<small class="text-lg font-normal opacity-60">°C</small></div>
                    <div class="text-xs opacity-50 mt-1">Temperature</div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold" id="humid-val">--.-<small class="text-lg font-normal opacity-60">%</small></div>
                    <div class="text-xs opacity-50 mt-1">Humidity</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center border-t border-white/10 pt-4">
                <div class="bg-white/5 rounded-lg p-2"><div class="text-[10px] opacity-50 mb-1">Door</div><div id="badge-door" class="font-bold text-sm">--</div></div>
                <div class="bg-white/5 rounded-lg p-2"><div class="text-[10px] opacity-50 mb-1">Key</div><div id="badge-key" class="font-bold text-sm">--</div></div>
                <div class="bg-white/5 rounded-lg p-2"><div class="text-[10px] opacity-50 mb-1">Light</div><div id="badge-light" class="font-bold text-sm">--</div></div>
            </div>
            <div class="mt-4 text-[10px] opacity-40 text-center" id="sensor-time">
                データ取得中...
            </div>
        </div>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[500px]">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-sm"><i class="fas fa-door-open text-emerald-500 mr-2"></i>在室状況</h3>
                <button onclick="updateStatus()" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="overflow-y-auto flex-grow">
                <table class="w-full text-left text-xs">
                    <thead class="bg-white sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-4 py-2 text-slate-400">名前</th>
                            <th class="px-4 py-2 text-slate-400">状態</th>
                            <th class="px-4 py-2 text-slate-400 text-right">滞在</th>
                        </tr>
                    </thead>
                    <tbody id="status-tbody" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // センサーと在室状況の更新スクリプト
    function updateSensor() {
        fetch("{{ url_for('api.api_sensor_status') }}").then(r=>r.json()).then(d=>{
            if(Object.keys(d).length === 0) return;
            if(d.temperature) {
                document.getElementById('temp-val').innerHTML = `${d.temperature}<small class="text-lg font-normal opacity-60">°C</small>`;
                document.getElementById('humid-val').innerHTML = `${d.humidity}<small class="text-lg font-normal opacity-60">%</small>`;
            }
            document.getElementById('sensor-time').textContent = "Updated: " + d.timestamp;

            const updateBadge = (id, val, openClass, closeClass) => {
                const el = document.getElementById(id);
                if(el) {
                    el.textContent = val;
                    el.className = `font-bold text-sm ${val.includes('開') || val.includes('点灯') ? openClass : closeClass}`;
                    if(id === 'badge-key' && val.includes('開')) { el.textContent = "OPEN"; el.className = `font-bold text-sm text-rose-400`; }
                    else if(id === 'badge-key' && val.includes('閉')) { el.textContent = "LOCK"; el.className = `font-bold text-sm text-emerald-400`; }
                }
            };
            updateBadge('badge-door', d.door, 'text-rose-400', 'text-emerald-400');
            updateBadge('badge-key', d.key || '--', 'text-rose-400', 'text-emerald-400');
            updateBadge('badge-light', d.light, 'text-yellow-400', 'text-slate-500');
        }).catch(e=>console.error(e));
    }

    function updateStatus() {
        fetch("{{ url_for('api.api_status') }}").then(r=>r.json()).then(d=>{
            const tb=document.getElementById('status-tbody'); 
            tb.innerHTML="";
            d.students.sort((a, b) => {
                const statusOrder = { "在室": 1, "一時退出中": 2, "退出": 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            });
            d.students.forEach(s=>{
                let cls="bg-slate-100 text-slate-500";
                if(s.status==="在室") cls="bg-emerald-100 text-emerald-700";
                else if(s.status==="一時退出中") cls="bg-yellow-100 text-yellow-700";
                
                tb.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-bold text-slate-700">${s.name}</td>
                        <td class="px-4 py-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${cls}">${s.status}</span></td>
                        <td class="px-4 py-3 text-slate-500 font-mono text-right">${s.duration||'-'}</td>
                    </tr>
                `);
            });
        });
    }
    setInterval(updateSensor, 5000); 
    setInterval(updateStatus, 5000);
    updateSensor(); updateStatus();
</script>
{% endblock %}
