<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ date_jpy }}の予定編集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
            color: #334155;
        }

        /* グラスモーフィズムカード */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
        }

        /* スケジュールセル */
        .schedule-slot {
            transition: all 0.15s ease-in-out;
            cursor: pointer;
            @apply border-2 border-transparent relative;
        }

        .schedule-slot:hover {
            @apply shadow-lg border-indigo-400 transform scale-[1.01] z-10;
        }
        
        .exception-tag {
            @apply absolute top-0.5 right-0.5 text-xs font-bold text-red-600 bg-red-100 px-1 rounded-full;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }

        .master-info {
            @apply text-xs text-slate-500 mt-1 pt-1 border-t border-slate-200;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
        
        <div class="w-full max-w-4xl flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-700 flex items-center">
                <i class="fa-solid fa-calendar-day mr-3"></i>
                <span class="hidden sm:inline">日別時間割編集</span>
            </h1>
            
            <a href="{{ url_for('schedule', date=date_str) }}" class="text-indigo-600 hover:text-indigo-800 transition font-medium">
                <i class="fa-solid fa-arrow-left mr-1"></i> 週予定に戻る
            </a>
        </div>
        
        <div class="glass-card p-4 sm:p-6 w-full max-w-4xl mb-6">
            <h2 class="text-2xl font-bold mb-1 text-slate-700">
                {{ date_jpy }} ({{ master_yobi }})
            </h2>
            <p class="text-sm text-slate-500">
                現在の基本設定：第<span class="font-semibold text-indigo-600">{{ kiki }}</span>期 <span class="text-xs">（マスター時間割の{{ master_yobi }}曜日が適用されます）</span>
            </p>
        </div>

        <div class="glass-card p-4 sm:p-6 w-full max-w-4xl">
            <div class="grid grid-cols-4 sm:grid-cols-5 gap-3">
                
                <div class="hidden sm:block text-slate-600 font-bold text-sm">時限</div>
                <div class="col-span-3 sm:col-span-4 text-slate-600 font-bold text-sm">授業情報</div>
                
                {% for period in period_nums %}
                
                <div class="hidden sm:flex items-center justify-center bg-indigo-50 text-indigo-700 font-extrabold text-xl rounded-lg h-full p-2">
                    {{ period }}
                </div>
                
                {% set slot = schedule[period] %}
                <div class="col-span-4 sm:col-span-4 rounded-xl p-3 shadow-md bg-white border border-slate-200 schedule-slot 
                            {% if slot.is_exception %} bg-red-50 border-red-300 {% elif slot.name in ['空欄', '休憩/空欄'] %} bg-slate-100 border-slate-300 {% else %} bg-white border-indigo-200 {% endif %}"
                    data-date="{{ date_str }}"
                    data-period="{{ period }}"
                    data-daily-id="{{ slot.daily_id if slot.daily_id else '' }}"
                    data-subject-id="{{ slot.subject_id if slot.subject_id else 0 }}"
                    data-room-id="{{ slot.room_id if slot.room_id else 0 }}"
                    data-remark="{{ slot.remark if slot.remark else '' }}"
                    onclick="openEditModal(this)">
                    
                    {% if slot.is_exception %}
                        <span class="exception-tag">例外変更</span>
                    {% endif %}
                    
                    <div class="flex items-center mb-1">
                        <span class="sm:hidden mr-2 bg-indigo-50 text-indigo-700 font-extrabold text-lg rounded-md px-2 py-1">{{ period }}</span>
                        <span class="text-lg font-bold text-slate-800 truncate">
                            {% if slot.name == '空欄' and period != 5 %}<i class="fa-solid fa-square-full text-slate-400 mr-2"></i> 空欄{% else %}{{ slot.name }}{% endif %}
                        </span>
                    </div>

                    {% if slot.name not in ['空欄', '休憩/空欄'] %}
                    <div class="text-sm flex items-center gap-4">
                        <span class="flex items-center text-slate-600">
                            <i class="fa-solid fa-user-tie text-xs mr-1 text-indigo-500"></i>
                            {{ slot.teacher }}
                        </span>
                        <span class="flex items-center text-slate-600">
                            <i class="fa-solid fa-map-location-dot text-xs mr-1 text-indigo-500"></i>
                            {{ slot.room }}
                        </span>
                    </div>
                    {% endif %}

                    {% if slot.remark and period == 5 %}
                    <div class="text-sm mt-1 pt-1 border-t border-slate-200 text-green-700">
                        <i class="fa-solid fa-file-lines text-xs mr-1"></i> 備考: {{ slot.remark }}
                    </div>
                    {% endif %}
                    
                    {% if slot.is_exception and slot.master_id and slot.name not in ['空欄', '休憩/空欄'] %}
                    <div class="master-info mt-2">
                        マスター: {{ schedule[period].name }} ({{ schedule[period].teacher }})
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
    
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-card w-full max-w-lg p-6 sm:p-8 transform transition-transform duration-300 translate-y-0"
             onclick="event.stopPropagation();">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-indigo-700">時間割の変更</h3>
            
            <form id="editForm" onsubmit="event.preventDefault(); saveDailySchedule();">
                <input type="hidden" id="modal_date_str" value="{{ date_str }}">
                <input type="hidden" id="modal_daily_id">
                <input type="hidden" id="modal_period">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">時限</label>
                    <p id="display_period" class="text-xl font-bold text-slate-800"></p>
                </div>

                <div id="subjectSection" class="mb-4">
                    <label for="selectSubject" class="block text-sm font-medium text-gray-700 mb-1">授業科目 <span class="text-red-500">*</span></label>
                    <select id="selectSubject" name="subject_id" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition shadow-sm">
                        <option value="0">--- 授業を空欄にする ---</option>
                        {% for subject in subject_list %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="roomSection" class="mb-4">
                    <label for="selectRoom" class="block text-sm font-medium text-gray-700 mb-1">教室 <span class="text-red-500">*</span></label>
                    <select id="selectRoom" name="room_id" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition shadow-sm">
                        <option value="0">--- 教室を空欄にする ---</option>
                        {% for room in room_list %}
                            <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="remarkSection" class="mb-6">
                    <label for="inputRemark" class="block text-sm font-medium text-gray-700 mb-1">備考/特別活動名 (5限は必須)</label>
                    <input type="text" id="inputRemark" name="remark" placeholder="特別活動、会議など" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition shadow-sm">
                </div>
                
                <div class="flex flex-col sm:flex-row justify-between gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeEditModal()" class="w-full sm:w-1/3 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition font-bold">
                        キャンセル
                    </button>
                    <div class="flex gap-3 w-full sm:w-2/3">
                        <button type="button" id="deleteButton" onclick="deleteDailySchedule()" class="flex-grow py-3 px-4 rounded-lg bg-red-500 text-white hover:bg-red-600 transition font-bold hidden">
                            <i class="fa-solid fa-trash mr-1"></i> 例外を削除
                        </button>
                        <button type="submit" id="saveButton" class="flex-grow py-3 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition font-bold">
                            <i class="fa-solid fa-save mr-1"></i> 変更を保存
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 opacity-0 z-50"></div>

    <script>
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const displayPeriod = document.getElementById('display_period');
        const subjectSection = document.getElementById('subjectSection');
        const roomSection = document.getElementById('roomSection');
        const remarkSection = document.getElementById('remarkSection');
        const selectSubject = document.getElementById('selectSubject');
        const selectRoom = document.getElementById('selectRoom');
        const inputRemark = document.getElementById('inputRemark');
        const deleteButton = document.getElementById('deleteButton');
        const saveButton = document.getElementById;
        const messageBox = document.getElementById('messageBox');
        
        let currentSlot = {}; // 編集中のスロットデータを保持

        function openEditModal(slotElement) {
            // データを取得
            const dateStr = slotElement.dataset.date;
            const period = slotElement.dataset.period;
            const dailyId = slotElement.dataset.dailyId;
            const subjectId = slotElement.dataset.subjectId;
            const roomId = slotElement.dataset.roomId;
            const remark = slotElement.dataset.remark;
            const masterName = slotElement.querySelector('.master-info') ? slotElement.querySelector('.master-info').textContent.replace('マスター: ', '').trim() : '';

            // 保持
            currentSlot = { date: dateStr, period: period, dailyId: dailyId };

            // モーダル表示内容の設定
            const masterInfoText = masterName ? ` (マスター: ${masterName})` : '';
            modalTitle.textContent = `${dateStr} • ${period}限 の予定`;
            displayPeriod.textContent = `${period}限 ${masterInfoText}`;

            document.getElementById('modal_daily_id').value = dailyId;
            document.getElementById('modal_period').value = period;

            // 5限判定とUI切り替え
            if (period === '5') {
                subjectSection.classList.add('hidden');
                roomSection.classList.add('hidden');
                remarkSection.classList.remove('hidden');
                inputRemark.value = remark || '';
                deleteButton.classList.toggle('hidden', !dailyId); // 例外がなければ削除ボタンは不要
            } else {
                subjectSection.classList.remove('hidden');
                roomSection.classList.remove('hidden');
                remarkSection.classList.add('hidden');
                selectSubject.value = subjectId || '0';
                selectRoom.value = roomId || '0';
                deleteButton.classList.toggle('hidden', !dailyId);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
        }

        function closeEditModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
        }
        
        // モーダル外クリックで閉じる
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeEditModal();
        });

        // メッセージ表示関数
        function showMessage(message, isSuccess = true) {
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 opacity-100 z-50 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // データの保存（追加または更新）
        async function saveDailySchedule() {
            const date = document.getElementById('modal_date_str').value;
            const period = document.getElementById('modal_period').value;
            const dailyId = document.getElementById('modal_daily_id').value;
            let subjectId = selectSubject.value;
            let roomId = selectRoom.value;
            let remark = inputRemark.value;

            // 5限のチェック
            if (period === '5') {
                subjectId = 0; // 5限は授業IDを使用しない
                roomId = 0;
                if (!remark) {
                    showMessage("5限は備考/特別活動名が必須です。", false);
                    return;
                }
            } else {
                 if (subjectId === '0' || roomId === '0') {
                    // 授業または教室が未選択の場合、削除（リセット）として処理
                    if (dailyId) {
                         // 日別例外が存在する場合のみ削除アクションを実行
                        await executeApi('delete', dailyId);
                        return;
                    } else {
                        // マスター時間割の内容を空欄で上書きする例外を新規作成
                        subjectId = 0;
                        roomId = 0;
                        remark = null;
                    }
                }
            }

            const action = dailyId ? 'update' : 'add';
            
            const payload = {
                date: date,
                period: period,
                action: action,
                daily_id: dailyId,
                subject_id: subjectId,
                room_id: roomId,
                remark: remark
            };

            const response = await fetch('{{ url_for("api_edit_daily_schedule") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                showMessage(result.message, true);
                closeEditModal();
                // ページをリロードして最新のスケジュールを反映
                window.location.reload();
            } else {
                showMessage(result.message, false);
            }
        }

        // 日別例外の削除
        async function deleteDailySchedule() {
            if (!confirm('本当にこの日別例外を削除し、マスター時間割の設定に戻しますか？')) {
                return;
            }
            await executeApi('delete', currentSlot.dailyId);
        }

        // API実行ヘルパー
        async function executeApi(action, dailyId) {
            const date = document.getElementById('modal_date_str').value;
            const period = document.getElementById('modal_period').value;

            const payload = {
                date: date,
                period: period,
                action: action,
                daily_id: dailyId 
            };
            
            const response = await fetch('{{ url_for("api_edit_daily_schedule") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                showMessage(result.message, true);
                closeEditModal();
                window.location.reload();
            } else {
                showMessage(result.message, false);
            }
        }
    </script>
</body>
</html>
