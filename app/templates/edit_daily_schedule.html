{% extends "base.html" %}

{% block title %}日別変更{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex items-center gap-2 mb-6 cursor-pointer text-slate-500 hover:text-indigo-600 w-fit" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> <span class="font-bold">戻る</span>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">{{ date_jpy }} <span class="text-sm font-normal text-slate-500">({{ master_yobi }}曜授業)</span></h2>
                <div class="text-xs text-slate-400 mt-1">この日だけの変更（休講・振替）を設定します</div>
            </div>
            <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded text-sm font-bold">
                第{{ kiki }}期
            </div>
        </div>

        <div class="space-y-4">
            {% for p in period_nums %}
                {% set slot = schedule[p] %}
                <div class="flex items-center gap-4 p-4 rounded-xl border transition
                            {{ 'bg-amber-50 border-amber-200' if slot.is_exception else 'bg-slate-50 border-slate-100' }}">
                    
                    <div class="w-12 h-12 flex items-center justify-center bg-white rounded-lg font-bold text-slate-600 shadow-sm">
                        {{ p }}限
                    </div>

                    <div class="flex-1">
                        {% if slot.is_exception %}
                            <div class="text-[10px] text-amber-600 font-bold mb-1"><i class="fas fa-exclamation-circle"></i> 変更あり</div>
                        {% endif %}
                        <div class="font-bold text-slate-800 text-lg">{{ slot.name }}</div>
                        {% if p != 5 and not slot.remark %}
                        <div class="text-xs text-slate-500">
                            <i class="fas fa-user-tie mr-1"></i>{{ slot.teacher }} 
                            <span class="mx-2">|</span> 
                            <i class="fas fa-map-marker-alt mr-1"></i>{{ slot.room }}
                        </div>
                        {% endif %}
                    </div>

                    <button onclick="openEditModal('{{ p }}', '{{ slot.subject_id or 0 }}', '{{ slot.room_id or 0 }}', '{{ slot.remark or '' }}', '{{ slot.daily_id or '' }}')" 
                            class="bg-white hover:bg-slate-100 text-slate-600 border border-slate-200 px-4 py-2 rounded-lg font-bold shadow-sm transition">
                        <i class="fas fa-pen"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="editModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
        <h3 class="font-bold text-xl mb-4 text-slate-700"><span id="modalPeriod"></span>限の変更</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">授業</label>
                <select id="modalSubject" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg">
                    <option value="0">（空き/休講）</option>
                    {% for s in subject_list %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">教室</label>
                <select id="modalRoom" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg">
                    <option value="0">指定なし</option>
                    {% for r in room_list %}
                    <option value="{{ r.id }}">{{ r.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">備考</label>
                <input type="text" id="modalRemark" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg" placeholder="例: 自習など">
            </div>
        </div>

        <div class="flex justify-between items-center mt-8">
            <button onclick="deleteException()" id="deleteBtn" class="text-rose-500 font-bold text-sm hover:underline hidden">設定を削除して元に戻す</button>
            <div class="flex gap-2 ml-auto">
                <button onclick="document.getElementById('editModal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">キャンセル</button>
                <button onclick="saveException()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPeriod, currentDailyId;

function openEditModal(period, subjectId, roomId, remark, dailyId) {
    currentPeriod = period;
    currentDailyId = dailyId;
    
    document.getElementById('modalPeriod').textContent = period;
    document.getElementById('modalSubject').value = subjectId;
    document.getElementById('modalRoom').value = roomId;
    document.getElementById('modalRemark').value = remark;
    
    const delBtn = document.getElementById('deleteBtn');
    if(dailyId && dailyId !== 'None') delBtn.classList.remove('hidden');
    else delBtn.classList.add('hidden');

    document.getElementById('editModal').classList.remove('hidden');
}

function saveException() {
    const data = {
        date: '{{ date_str }}',
        period: currentPeriod,
        action: 'update',
        subject_id: document.getElementById('modalSubject').value,
        room_id: document.getElementById('modalRoom').value,
        remark: document.getElementById('modalRemark').value
    };
    sendUpdate(data);
}

function deleteException() {
    if(!confirm("この変更を削除して、元の時間割に戻しますか？")) return;
    const data = {
        date: '{{ date_str }}',
        period: currentPeriod,
        action: 'delete',
        daily_id: currentDailyId
    };
    sendUpdate(data);
}

function sendUpdate(data) {
    fetch("{{ url_for('api.api_edit_daily_schedule') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(res => res.json()).then(d => {
        if(d.status === 'success') location.reload();
        else alert('エラー: ' + d.message);
    }).catch(e => alert('通信エラー'));
}
</script>
{% endblock %}
